# JaCoCo Report Viewer (jrv) — 要件定義書

JaCoCo カバレッジレポート ターミナルナビゲータ

---

## 1. 概要

### 1.1 プロジェクト概要

jrv は、JaCoCo が出力する XML カバレッジレポートをターミナル上でインタラクティブに閲覧するための CLI ツールである。HTML レポートをブラウザで開く代わりに、ターミナル上でリンクをたどるようにドリルダウンしながらカバレッジ情報を確認できる。

### 1.2 背景と動機

JaCoCo は Java プロジェクトにおけるコードカバレッジ計測のデファクトスタンダードであるが、レポートの確認手段は HTML レポートをブラウザで開くか、CI ツール上で閲覧するかに限られている。ターミナル中心の開発ワークフローにおいて、コンテキストスイッチなしにカバレッジを確認できるツールが存在しない。

### 1.3 ゴール

- ターミナルから離れずに JaCoCo カバレッジレポートを確認できること
- HTML レポートと同等のナビゲーション体験をターミナル上で提供すること
- インストールと利用が簡単であること

### 1.4 技術スタック

| 項目 | 選定 |
|---|---|
| 言語 | Go |
| TUI フレームワーク | bubbletea + lipgloss |
| XML パース | encoding/xml（標準ライブラリ） |
| ビルド / リリース | GoReleaser |
| 入力フォーマット | JaCoCo XML（M1）、将来はCobertura XML/LCOVを想定 |

---

## 2. ユーザーストーリー

### US-1: レポートを開く

開発者として、ターミナルからコマンド一つで JaCoCo レポートを開きたい。カバレッジの全体像をすぐに把握したい。

**受け入れ条件:**

- `jrv` を実行するとカバレッジレポートが表示される
- Maven プロジェクトルートで実行した場合、`pom.xml` から JaCoCo プラグインの設定を読み取り、レポートパスを自動解決する
- `pom.xml` が見つからない、または JaCoCo プラグインが未設定の場合は既知のデフォルトパスにフォールバックする
- XML が見つからない場合、エラーメッセージとヒントを表示する

### US-2: パッケージにドリルダウンする

開発者として、全体サマリからパッケージ一覧に移動し、特定のパッケージを選択して中に入りたい。

**受け入れ条件:**

- 全体サマリ画面にパッケージ一覧が表示される
- カーソルキーで選択し、Enter で中に入れる
- パッケージのカバレッジ率が一覧上で確認できる

### US-3: クラス → メソッドへドリルダウンする

開発者として、パッケージからクラス、クラスからメソッドへと掘り下げたい。

**受け入れ条件:**

- パッケージ内のクラス一覧が表示される
- クラスを選択するとメソッド一覧が表示される
- 各階層でカバレッジ率が確認できる

### US-4: 上の階層に戻る

開発者として、いつでも上の階層に戻りたい。今どこにいるかを常に把握したい。

**受け入れ条件:**

- `b` キーまたは Backspace で親階層に戻れる
- パンくずリストで現在位置が表示される
- 最上位で「戻る」を実行しても何も起きない（エラーにならない）

### US-5: ソート順を切り替える

開発者として、カバレッジ率が低い順にソートして問題箇所を素早く特定したい。

**受け入れ条件:**

- `s` キーでソート基準を切り替えられる
- ソート基準: 名前（昇順）、カバレッジ率（昇順 / 降順）
- 現在のソート状態が画面上に表示される

### US-6: カバレッジ不足箇所を視覚的に把握する

開発者として、閾値を下回るカバレッジを色で即座に判別したい。

**受け入れ条件:**

- 閾値（デフォルト 80%）を下回る項目が赤で表示される
- 閾値以上 90% 未満が黄色、90% 以上が緑で表示される
- 閾値はコマンドライン引数で変更可能

---

## 3. 機能要件

### 3.1 データ入力

| ID | 要件 | 優先度 |
|---|---|---|
| F-IN-01 | JaCoCo XML レポートファイルをパースできること | 必須 |
| F-IN-02 | コマンドライン引数でファイルパスを指定できること | 必須 |
| F-IN-03 | `pom.xml` を読み取り、JaCoCo プラグイン設定からレポートパスを自動解決すること | 必須 |
| F-IN-04 | POM が見つからない場合、デフォルトパスにフォールバックすること | 必須 |
| F-IN-05 | マルチモジュールプロジェクトの複数 XML をマージできること | 将来 |
| F-IN-06 | Cobertura XML をパースし既存ツリー（Report/Package/Class/Method）へ正規化できること | 将来 |
| F-IN-07 | 入力フォーマットを自動判別し、必要に応じて `--format` で明示指定できること | 将来 |
| F-IN-08 | LCOV をパースし既存ツリーへ正規化できること | 将来 |

#### 3.1.1 POM 解析によるレポートパス解決

引数省略時、以下の順序でレポートを探索する。

##### ステップ 1: pom.xml の検出

カレントディレクトリから `pom.xml` を探す。

##### ステップ 2: JaCoCo プラグイン設定の読み取り

`pom.xml` 内の以下のパスから JaCoCo プラグインの設定を取得する。

```xml
<project>
  <build>
    <plugins>
      <plugin>
        <groupId>org.jacoco</groupId>
        <artifactId>jacoco-maven-plugin</artifactId>
        <configuration>
          <!-- outputDirectory が指定されていればそのパスを使用 -->
          <!-- dataFile が指定されていればそのパスを使用 -->
        </configuration>
        <executions>
          <execution>
            <goals>
              <goal>report</goal>
            </goals>
            <configuration>
              <outputDirectory>...</outputDirectory>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>
```

取得する情報:

| POM 要素 | 用途 | デフォルト値 |
|---|---|---|
| `outputDirectory` | レポート出力先ディレクトリ | `${project.reporting.outputDirectory}/jacoco` |
| `dataFile` | 実行データファイル（.exec） | `${project.build.directory}/jacoco.exec` |

`<pluginManagement>` 内の定義も探索対象とする。

##### ステップ 3: レポート XML の探索

解決したディレクトリ内から `jacoco.xml` を探す。

##### ステップ 4: フォールバック

POM が存在しない、または JaCoCo プラグインが見つからない場合、以下のデフォルトパスを順に探索する。

1. `target/site/jacoco/jacoco.xml` (Maven デフォルト)
2. `build/reports/jacoco/test/jacocoTestReport.xml` (Gradle)

### 3.2 データモデル

レポートデータは以下の階層ツリーとして扱う。

```text
Report (root)
  └── Package
        └── Class
              └── Method
```

各ノードは以下のカウンタを保持する。

| カウンタ | 説明 |
|---|---|
| INSTRUCTION | バイトコード命令 |
| BRANCH | 分岐 |
| LINE | ソース行 |
| COMPLEXITY | 循環的複雑度 |
| METHOD | メソッド |
| CLASS | クラス |

カウンタはそれぞれ `missed` と `covered` を持ち、カバレッジ率は `covered / (missed + covered) * 100` で算出する。

### 3.3 画面構成

#### 3.3.1 共通レイアウト

```text
┌─ パンくずリスト ──────────────────────────────────┐
│                                                    │
│  現在ノードのサマリ（カバレッジバー）                 │
│                                                    │
│  子ノード一覧（カーソル付き）                        │
│                                                    │
│  フッター（キーバインドヘルプ）                       │
└────────────────────────────────────────────────────┘
```

#### 3.3.2 パンくずリスト

現在の階層パスを表示する。

```text
Report > com.example.service > UserService
```

#### 3.3.3 サマリ表示

現在ノードの各カウンタについてカバレッジ率とバーを表示する。

```text
Instruction:  78.3%  ████████████████░░░░
Branch:       65.1%  █████████████░░░░░░░
Line:         81.2%  ████████████████░░░░
Method:       92.0%  ██████████████████░░
```

#### 3.3.4 子ノード一覧

カーソルで選択可能なリスト。各行にノード名とカバレッジ率（Instruction ベース）を表示する。

```text
❯ com.example.service       82.3%  ████████░░
  com.example.controller    71.5%  ███████░░░
  com.example.repository    90.1%  █████████░
```

### 3.4 ナビゲーション

| ID | 要件 | 優先度 |
|---|---|---|
| F-NAV-01 | `↑` / `↓` または `k` / `j` でカーソルを移動できること | 必須 |
| F-NAV-02 | `Enter` で子ノードに入れること | 必須 |
| F-NAV-03 | `b` または `Backspace` で親ノードに戻れること | 必須 |
| F-NAV-04 | `q` または `Ctrl+C` で終了できること | 必須 |
| F-NAV-05 | `s` でソート基準を切り替えられること | 必須 |
| F-NAV-06 | `/` でフィルター（名前検索）できること | 将来 |
| F-NAV-07 | `g` / `G` でリスト先頭 / 末尾にジャンプできること | 任意 |

### 3.5 表示

| ID | 要件 | 優先度 |
|---|---|---|
| F-DSP-01 | カバレッジ率を閾値に応じて色分けすること | 必須 |
| F-DSP-02 | カバレッジバーを表示すること | 必須 |
| F-DSP-03 | カウンタの表示種別を切り替えられること（Instruction / Branch / Line） | 任意 |
| F-DSP-04 | ターミナル幅に応じてレイアウトを調整すること | 任意 |
| F-DSP-05 | `--no-color` オプションで色を無効化できること | 任意 |

---

## 4. 非機能要件

| ID | 要件 | 目標値 |
|---|---|---|
| NF-01 | 起動時間 | 1,000 クラス規模の XML で 1 秒以内 |
| NF-02 | 対応 OS | macOS (arm64 / x86_64), Linux (x86_64)。Windows は将来 |
| NF-03 | 対応 Go バージョン | Go 1.22 以上（ビルド時） |
| NF-04 | 依存パッケージ | 最小限に留めること |
| NF-05 | 配布 | Homebrew および `go install` の 2 経路で配布すること |
| NF-06 | JaCoCo バージョン | 0.8.x 系の XML スキーマに対応 |
| NF-07 | バイナリサイズ | シングルバイナリ、ランタイム依存なし |
| NF-08 | 命名整合性 | JaCoCo専用名称から将来の多言語対応に整合する製品名へ移行計画を持つこと |

### 4.1 配布方式

#### Homebrew

```bash
brew install jrv
```

- Homebrew Tap (`homebrew-jrv`) を提供する
- GoReleaser で GitHub Releases へのバイナリ公開と Homebrew Formula の自動生成を行う
- macOS (arm64 / x86_64)、Linux (x86_64) 向けにクロスコンパイルする
- ユーザー環境にランタイム依存なし

#### go install

```bash
go install github.com/<owner>/jrv@latest
```

- Go ツールチェインがある環境向けの配布経路

---

## 5. コマンドラインインターフェース

```text
jrv [options] [path]
```

### 引数

| 引数 | 説明 | デフォルト |
|---|---|---|
| `path` | JaCoCo XML レポートのパス | 自動検出 |

### オプション

| オプション | 説明 | デフォルト |
|---|---|---|
| `-t, --threshold <n>` | カバレッジ閾値（%） | `80` |
| `-s, --sort <key>` | 初期ソート: `name`, `coverage` | `name` |
| `--no-color` | カラー出力を無効化 | `false` |
| `-v, --version` | バージョンを表示 | - |
| `-h, --help` | ヘルプを表示 | - |

---

## 6. 将来の拡張

| ID | 機能 | 説明 |
|---|---|---|
| FUT-01 | ソースコード表示 | メソッド階層からソースファイルの行カバレッジを表示 |
| FUT-02 | マルチモジュール対応 | POM の `<modules>` を読み取り、各サブモジュールの XML をマージ表示 |
| FUT-03 | diff モード | 2 つの XML を比較してカバレッジの増減を表示 |
| FUT-04 | フィルター | パッケージ名・クラス名でインクリメンタル検索 |
| FUT-05 | エクスポート | 現在の表示をテキスト / JSON で出力 |
| FUT-06 | Watch モード | XML の変更を監視して自動更新 |
| FUT-07 | Python対応 | `coverage.py` 由来の Cobertura XML を取り込み表示する |
| FUT-08 | Rust対応 | LCOV 等を取り込み表示する |
| FUT-09 | リネーム対応 | プロダクト名・CLI名・配布名をJaCoCo専用から汎用名へ移行する |

### 6.1 命名移行ポリシー（将来）

- 現名称（`JaCoCo Report Viewer CLI`, `jrv`）はM1では維持する。
- 多言語入力（Cobertura/LCOV）を正式サポートする時点で、名称変更を実施する。
- 変更対象はリポジトリ名、CLI名、Homebrewパッケージ名、README/要件書の表記とする。
- 互換期間中は旧コマンド名の案内またはエイリアス提供を行う。

---

## 7. 用語定義

| 用語 | 定義 |
|---|---|
| JaCoCo | Java Code Coverage の略。Java 向けカバレッジ計測ライブラリ |
| カウンタ | カバレッジの計測単位（Instruction, Branch, Line, Method 等） |
| ドリルダウン | 上位の集約データから下位の詳細データへ階層的にたどる操作 |
| パンくずリスト | 現在の階層位置を示すナビゲーション要素 |
| 閾値 | カバレッジの良否を判定するための基準値 |

---

## 改訂履歴

| 版 | 日付 | 内容 |
|---|---|---|
| 0.1 | 2025-02-19 | 初版作成 |
| 0.2 | 2026-02-19 | 将来要件にCobertura/LCOV入力と命名移行ポリシーを追加 |
